---
interface Props {
    dayNumber: number;
    year: number;
    month: number;
    isSelected?: boolean;
    selectionType?: string;
}

const {
    dayNumber,
    year,
    month,
    isSelected = false,
    selectionType = "",
} = Astro.props;

// Create the full date string for this day
const date = new Date(year, month, dayNumber);
const dateString = date.toISOString().split("T")[0]; // Format: YYYY-MM-DD

const selectionColors: Record<string, string> = {
    "work-from-home": "#1890ff", // Blue
    vacation: "#52c41a",
    "sick-leave": "#faad14",
    personal: "#722ed1",
    office: "#f5222d", // Red
    default: "#d9d9d9",
};

// Create a unique ID for this day cell
const cellId = `day-cell-${dateString}-${dayNumber}`;
---

<td
    id={cellId}
    class="calendar-day"
    data-day={dayNumber}
    data-date={dateString}
    data-year={year}
    data-month={month}
    data-selected={isSelected}
    data-selection-type={selectionType}
    style={{
        backgroundColor:
            isSelected && selectionType
                ? selectionColors[selectionType]
                : "transparent",
    }}
>
    <span class="day-number">{dayNumber}</span>
</td>

<script define:vars={{ cellId }}>
    // Global drag state (shared across all day cells)
    let isDragging = false;
    let dragSelectionType = null;

    // Initialize drag state on first use
    if (!window.__calendarDragState) {
        window.__calendarDragState = {
            isDragging: false,
            selectionType: null,
        };
    }

    // Wait for DOM to be ready
    function initDayCell() {
        const cell = document.getElementById(cellId);
        if (!cell) {
            console.warn(`Day cell not found: ${cellId}`);
            return;
        }

        // Get global drag state
        const dragState = window.__calendarDragState;

        // Apply a selection type to a cell
        function applySelection(targetCell, type) {
            if (type === null) {
                targetCell.dataset.selected = "false";
                targetCell.dataset.selectionType = "";
                targetCell.style.backgroundColor = "transparent";
            } else if (type === "work-from-home") {
                targetCell.dataset.selected = "true";
                targetCell.dataset.selectionType = "work-from-home";
                targetCell.style.backgroundColor = "#1890ff";
            } else if (type === "office") {
                targetCell.dataset.selected = "true";
                targetCell.dataset.selectionType = "office";
                targetCell.style.backgroundColor = "#f5222d";
            }
        }

        // Handle mouse down - start dragging
        cell.addEventListener("mousedown", (e) => {
            if (e.button === 0 || e.button === 2) {
                // Left or right click
                e.preventDefault();

                const currentType = cell.dataset.selectionType || "";
                const newType = e.button === 0 ? "work-from-home" : "office";

                // Toggle logic: if clicking the same type, clear it
                dragState.selectionType =
                    currentType === newType ? null : newType;
                dragState.isDragging = true;

                // Apply the selection to this cell
                applySelection(cell, dragState.selectionType);
            }
        });

        // Handle mouse enter - apply selection if dragging
        cell.addEventListener("mouseenter", (e) => {
            if (dragState.isDragging && dragState.selectionType !== null) {
                applySelection(cell, dragState.selectionType);
            }
        });

        // Prevent context menu on right-click
        cell.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            e.stopPropagation();
        });
    }

    // Global mouse up handler - stop dragging
    function stopDragging() {
        const dragState = window.__calendarDragState;
        if (dragState) {
            dragState.isDragging = false;
            dragState.selectionType = null;
        }
    }

    // Add global mouse up listener once
    if (!window.__calendarMouseUpListenerAdded) {
        document.addEventListener("mouseup", stopDragging);
        document.addEventListener("mouseleave", stopDragging);
        window.__calendarMouseUpListenerAdded = true;
    }

    // Initialize when DOM is ready
    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initDayCell);
    } else {
        initDayCell();
    }
</script>

<style>
    .calendar-day {
        width: 2rem;
        height: 2rem;
        font-size: 0.9rem;
        vertical-align: middle;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        text-align: center;
        padding: 0;
        border: 1px solid transparent;
        user-select: none; /* Prevent text selection */
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    .day-number {
        display: inline-block;
        width: 100%;
        height: 100%;
        line-height: 2rem;
        pointer-events: none; /* Allow clicks to pass through to the td */
    }

    /* Change hover outline to dark grey */
    .calendar-day:hover {
        box-shadow: 0 0 0 2px #555 inset;
        border-color: #555;
    }

    .calendar-day.empty {
        background-color: #f9f9f9;
        pointer-events: none;
    }
</style>
