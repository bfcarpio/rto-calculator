---
// Holiday Country Selector Component
---

<div class="holiday-selector" id="holiday-selector">
  <button class="selector-header" id="selector-toggle" aria-expanded="false" aria-controls="selector-drawer">
    <div class="header-content">
      <h3 class="selector-title">üóìÔ∏è Add Public Holidays</h3>
      <p class="selector-description">
        Select a country to automatically mark public holidays
      </p>
    </div>
    <span class="chevron" aria-hidden="true">‚ñº</span>
  </button>
  
  <div class="selector-drawer" id="selector-drawer">
    <div class="selector-controls">
      <select 
        id="country-select" 
        class="country-select"
      >
        <option value="">Select a country...</option>
      </select>
      
      <button 
        id="add-holidays-button" 
        class="add-holidays-button"
        disabled
      >
        Add Holidays
      </button>
    </div>
    
    <div id="holiday-status" class="holiday-status"></div>
  </div>
</div>

<style>
  .holiday-selector {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .selector-header {
    all: unset;
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    cursor: pointer;
    padding: 0;
    margin-bottom: 0;
  }

  .header-content {
    flex: 1;
  }

  .chevron {
    font-size: 1rem;
    color: #64748b;
    transition: transform 0.3s ease;
    flex-shrink: 0;
    margin-left: 0.5rem;
    display: inline-block;
  }

  .selector-header[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  .selector-drawer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease;
    opacity: 0;
  }

  .selector-drawer.open {
    max-height: 200px;
    opacity: 1;
    margin-top: 0.75rem;
    overflow: visible;
  }

  .selector-title {
    font-size: 1rem;
    font-weight: 600;
    color: #334155;
    margin: 0 0 0.25rem 0;
  }

  .selector-description {
    font-size: 0.875rem;
    color: #64748b;
    margin: 0;
  }

  .selector-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 1;
  }

  .country-select {
    flex: 1;
    padding: 0.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.875rem;
    background: white;
    position: relative;
    z-index: 100;
    appearance: auto;
    -webkit-appearance: menulist;
    -moz-appearance: menulist;
    min-height: 40px;
    opacity: 1;
    cursor: pointer;
  }

  .country-select:disabled {
    background: #f1f5f9;
    color: #94a3b8;
  }

  .add-holidays-button {
    padding: 0.5rem 1rem;
    background: #475569;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
    white-space: nowrap;
  }

  .add-holidays-button:hover:not(:disabled) {
    background: #334155;
  }

  .add-holidays-button:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
  }

  .holiday-status {
    font-size: 0.875rem;
  }

  .holiday-status.success {
    color: #059669;
  }

  .holiday-status.error {
    color: #dc2626;
  }

  .holiday-status.loading {
    color: #475569;
  }

  :global(body.dark-mode) .holiday-selector {
    background: #1e293b;
    border-color: #334155;
  }

  :global(body.dark-mode) .selector-title {
    color: #e2e8f0;
  }

  :global(body.dark-mode) .selector-description {
    color: #94a3b8;
  }

  :global(body.dark-mode) .chevron {
    color: #94a3b8;
  }

  :global(body.dark-mode) .country-select {
    background: #1e293b;
    border-color: #334155;
    color: #e2e8f0;
  }

  :global(body.dark-mode) .country-select:disabled {
    background: #334155;
    color: #64748b;
  }

  @media (max-width: 768px) {
    .selector-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .add-holidays-button {
      width: 100%;
    }
  }
</style>

<script>
  import { getDateStore } from '../lib/dateStore';

  interface Country {
    countryCode: string;
    name: string;
  }

  interface Holiday {
    date: Date;
    name: string;
  }

  const COUNTRIES: Country[] = [
    { countryCode: "", name: "Select a country..." },
    { countryCode: "AD", name: "Andorra" },
    { countryCode: "AL", name: "Albania" },
    { countryCode: "AM", name: "Armenia" },
    { countryCode: "AR", name: "Argentina" },
    { countryCode: "AT", name: "Austria" },
    { countryCode: "AU", name: "Australia" },
    { countryCode: "AX", name: "√Öland Islands" },
    { countryCode: "BA", name: "Bosnia and Herzegovina" },
    { countryCode: "BB", name: "Barbados" },
    { countryCode: "BE", name: "Belgium" },
    { countryCode: "BG", name: "Bulgaria" },
    { countryCode: "BJ", name: "Benin" },
    { countryCode: "BO", name: "Bolivia" },
    { countryCode: "BR", name: "Brazil" },
    { countryCode: "BS", name: "Bahamas" },
    { countryCode: "BW", name: "Botswana" },
    { countryCode: "BY", name: "Belarus" },
    { countryCode: "BZ", name: "Belize" },
    { countryCode: "CA", name: "Canada" },
    { countryCode: "CD", name: "DR Congo" },
    { countryCode: "CG", name: "Congo" },
    { countryCode: "CH", name: "Switzerland" },
    { countryCode: "CL", name: "Chile" },
    { countryCode: "CN", name: "China" },
    { countryCode: "CO", name: "Colombia" },
    { countryCode: "CR", name: "Costa Rica" },
    { countryCode: "CU", name: "Cuba" },
    { countryCode: "CY", name: "Cyprus" },
    { countryCode: "CZ", name: "Czechia" },
    { countryCode: "DE", name: "Germany" },
    { countryCode: "DK", name: "Denmark" },
    { countryCode: "DO", name: "Dominican Republic" },
    { countryCode: "EC", name: "Ecuador" },
    { countryCode: "EE", name: "Estonia" },
    { countryCode: "EG", name: "Egypt" },
    { countryCode: "ES", name: "Spain" },
    { countryCode: "FI", name: "Finland" },
    { countryCode: "FO", name: "Faroe Islands" },
    { countryCode: "FR", name: "France" },
    { countryCode: "GA", name: "Gabon" },
    { countryCode: "GB", name: "United Kingdom" },
    { countryCode: "GD", name: "Grenada" },
    { countryCode: "GE", name: "Georgia" },
    { countryCode: "GG", name: "Guernsey" },
    { countryCode: "GH", name: "Ghana" },
    { countryCode: "GI", name: "Gibraltar" },
    { countryCode: "GL", name: "Greenland" },
    { countryCode: "GM", name: "Gambia" },
    { countryCode: "GR", name: "Greece" },
    { countryCode: "GT", name: "Guatemala" },
    { countryCode: "GY", name: "Guyana" },
    { countryCode: "HK", name: "Hong Kong" },
    { countryCode: "HN", name: "Honduras" },
    { countryCode: "HR", name: "Croatia" },
    { countryCode: "HT", name: "Haiti" },
    { countryCode: "HU", name: "Hungary" },
    { countryCode: "ID", name: "Indonesia" },
    { countryCode: "IE", name: "Ireland" },
    { countryCode: "IM", name: "Isle of Man" },
    { countryCode: "IS", name: "Iceland" },
    { countryCode: "IT", name: "Italy" },
    { countryCode: "JE", name: "Jersey" },
    { countryCode: "JM", name: "Jamaica" },
    { countryCode: "JP", name: "Japan" },
    { countryCode: "KE", name: "Kenya" },
    { countryCode: "KR", name: "South Korea" },
    { countryCode: "KZ", name: "Kazakhstan" },
    { countryCode: "LI", name: "Liechtenstein" },
    { countryCode: "LS", name: "Lesotho" },
    { countryCode: "LT", name: "Lithuania" },
    { countryCode: "LU", name: "Luxembourg" },
    { countryCode: "LV", name: "Latvia" },
    { countryCode: "MA", name: "Morocco" },
    { countryCode: "MC", name: "Monaco" },
    { countryCode: "MD", name: "Moldova" },
    { countryCode: "ME", name: "Montenegro" },
    { countryCode: "MG", name: "Madagascar" },
    { countryCode: "MK", name: "North Macedonia" },
    { countryCode: "MN", name: "Mongolia" },
    { countryCode: "MS", name: "Montserrat" },
    { countryCode: "MT", name: "Malta" },
    { countryCode: "MX", name: "Mexico" },
    { countryCode: "MZ", name: "Mozambique" },
    { countryCode: "NA", name: "Namibia" },
    { countryCode: "NE", name: "Niger" },
    { countryCode: "NG", name: "Nigeria" },
    { countryCode: "NI", name: "Nicaragua" },
    { countryCode: "NL", name: "Netherlands" },
    { countryCode: "NO", name: "Norway" },
    { countryCode: "NZ", name: "New Zealand" },
    { countryCode: "PA", name: "Panama" },
    { countryCode: "PE", name: "Peru" },
    { countryCode: "PG", name: "Papua New Guinea" },
    { countryCode: "PH", name: "Philippines" },
    { countryCode: "PL", name: "Poland" },
    { countryCode: "PR", name: "Puerto Rico" },
    { countryCode: "PT", name: "Portugal" },
    { countryCode: "PY", name: "Paraguay" },
    { countryCode: "RO", name: "Romania" },
    { countryCode: "RS", name: "Serbia" },
    { countryCode: "RU", name: "Russia" },
    { countryCode: "SE", name: "Sweden" },
    { countryCode: "SG", name: "Singapore" },
    { countryCode: "SI", name: "Slovenia" },
    { countryCode: "SJ", name: "Svalbard and Jan Mayen" },
    { countryCode: "SK", name: "Slovakia" },
    { countryCode: "SM", name: "San Marino" },
    { countryCode: "SR", name: "Suriname" },
    { countryCode: "SV", name: "El Salvador" },
    { countryCode: "TN", name: "Tunisia" },
    { countryCode: "TR", name: "T√ºrkiye" },
    { countryCode: "UA", name: "Ukraine" },
    { countryCode: "US", name: "United States" },
    { countryCode: "UY", name: "Uruguay" },
    { countryCode: "VA", name: "Vatican City" },
    { countryCode: "VE", name: "Venezuela" },
    { countryCode: "VN", name: "Vietnam" },
    { countryCode: "ZA", name: "South Africa" },
    { countryCode: "ZW", name: "Zimbabwe" }
  ];

  const BASE_URL = 'https://date.nager.at';

  // Convert country code to flag emoji (e.g., "US" ‚Üí "üá∫üá∏")
  function getFlagEmoji(countryCode: string): string {
    const codePoints = countryCode
      .toUpperCase()
      .split('')
      .map(char => 127397 + char.charCodeAt(0));
    return String.fromCodePoint(...codePoints);
  }

  function loadCountries(countrySelect: HTMLSelectElement): void {
    // Clear existing options
    countrySelect.innerHTML = '';

    // Populate dropdown from hardcoded countries
    COUNTRIES.forEach((country) => {
      const option = document.createElement('option');
      option.value = country.countryCode;
      if (country.countryCode) {
        const flag = getFlagEmoji(country.countryCode);
        option.textContent = `${flag} ${country.name}`;
      } else {
        option.textContent = country.name;
      }
      countrySelect.appendChild(option);
    });
  }

  function initializeComponent(): void {
    const countrySelect = document.getElementById('country-select') as HTMLSelectElement | null;
    const addButton = document.getElementById('add-holidays-button') as HTMLButtonElement | null;
    const statusDiv = document.getElementById('holiday-status');
    const toggleButton = document.getElementById('selector-toggle') as HTMLButtonElement | null;
    const drawer = document.getElementById('selector-drawer');

    if (!countrySelect || !addButton || !toggleButton || !drawer) {
      console.error('[HolidayCountrySelector] Required elements not found');
      return;
    }

    const dateStore = getDateStore();

    // Toggle drawer open/closed
    toggleButton.addEventListener('click', () => {
      const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
      toggleButton.setAttribute('aria-expanded', String(!isExpanded));
      drawer.classList.toggle('open', !isExpanded);
    });

    function updateButtonState(): void {
      addButton!.disabled = !countrySelect!.value;
    }

    async function addHolidays(): Promise<void> {
      const countryCode = countrySelect!.value;
      if (!countryCode) return;

      try {
        if (statusDiv) {
          statusDiv.className = 'holiday-status loading';
          statusDiv.textContent = 'Fetching holidays...';
        }
        addButton!.disabled = true;

        const currentYear = new Date().getFullYear();
        
        // Dynamic import
        const { Configuration, PublicHolidayApi } = await import('nager_date_api_reference');

        const config = new Configuration({ basePath: BASE_URL });
        const holidayApi = new PublicHolidayApi(config);

        const holidays = await holidayApi.apiV3PublicHolidaysYearCountryCodeGet({ 
          year: currentYear, 
          countryCode 
        }) as Holiday[];

        const dateRange = dateStore.getDateRange();
        let addedCount = 0;

        for (const holiday of holidays) {
          const holidayDate = holiday.date;
          
          if (holidayDate >= dateRange.startDate && holidayDate <= dateRange.endDate) {
            const existingState = dateStore.getDateState(holidayDate);
            if (!existingState || existingState !== 'holiday') {
              dateStore.markDate(holidayDate, 'holiday', true);
              addedCount++;
            }
          }
        }

        if (statusDiv) {
          statusDiv.className = 'holiday-status success';
          statusDiv.textContent = `Added ${addedCount} holidays!`;
        }

        setTimeout(() => {
          if (statusDiv) {
            statusDiv.textContent = '';
          }
        }, 3000);
      } catch (error) {
        console.error('Failed to add holidays:', error);
        if (statusDiv) {
          statusDiv.className = 'holiday-status error';
          statusDiv.textContent = 'Failed to fetch holidays. Please try again.';
        }
      } finally {
        updateButtonState();
      }
    }

    // Initialize
    loadCountries(countrySelect);
    countrySelect.addEventListener('change', updateButtonState);
    addButton.addEventListener('click', addHolidays);
  }

  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeComponent);
  } else {
    initializeComponent();
  }
</script>
