---
// Holiday Country Selector Component
---

<div class="holiday-selector" id="holiday-selector">
  <button class="selector-header" id="selector-toggle" aria-expanded="false" aria-controls="selector-drawer">
    <div class="header-content">
      <h3 class="selector-title">üóìÔ∏è Add Public Holidays</h3>
      <p class="selector-description">
        Select a country to automatically mark public holidays
      </p>
    </div>
    <span class="chevron" aria-hidden="true">‚ñº</span>
  </button>
  
  <div class="selector-drawer" id="selector-drawer">
    <div class="selector-controls">
      <select 
        id="country-select" 
        class="country-select"
        disabled
      >
        <option value="">Loading countries...</option>
      </select>
      
      <button 
        id="add-holidays-button" 
        class="add-holidays-button"
        disabled
      >
        Add Holidays
      </button>
    </div>
    
    <div id="holiday-status" class="holiday-status"></div>
  </div>
</div>

<style>
  .holiday-selector {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .selector-header {
    all: unset;
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    cursor: pointer;
    padding: 0;
    margin-bottom: 0;
  }

  .header-content {
    flex: 1;
  }

  .chevron {
    font-size: 1rem;
    color: #64748b;
    transition: transform 0.3s ease;
    flex-shrink: 0;
    margin-left: 0.5rem;
    display: inline-block;
  }

  .selector-header[aria-expanded="true"] .chevron {
    transform: rotate(180deg);
  }

  .selector-drawer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, opacity 0.3s ease;
    opacity: 0;
  }

  .selector-drawer.open {
    max-height: 200px;
    opacity: 1;
    margin-top: 0.75rem;
  }

  .selector-title {
    font-size: 1rem;
    font-weight: 600;
    color: #334155;
    margin: 0 0 0.25rem 0;
  }

  .selector-description {
    font-size: 0.875rem;
    color: #64748b;
    margin: 0;
  }

  .selector-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .country-select {
    flex: 1;
    padding: 0.5rem;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 0.875rem;
    background: white;
  }

  .country-select:disabled {
    background: #f1f5f9;
    color: #94a3b8;
  }

  .add-holidays-button {
    padding: 0.5rem 1rem;
    background: #475569;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 500;
    cursor: pointer;
    transition: background-color 0.2s ease;
    white-space: nowrap;
  }

  .add-holidays-button:hover:not(:disabled) {
    background: #334155;
  }

  .add-holidays-button:disabled {
    background: #cbd5e1;
    cursor: not-allowed;
  }

  .holiday-status {
    font-size: 0.875rem;
  }

  .holiday-status.success {
    color: #059669;
  }

  .holiday-status.error {
    color: #dc2626;
  }

  .holiday-status.loading {
    color: #475569;
  }

  :global(body.dark-mode) .holiday-selector {
    background: #1e293b;
    border-color: #334155;
  }

  :global(body.dark-mode) .selector-title {
    color: #e2e8f0;
  }

  :global(body.dark-mode) .selector-description {
    color: #94a3b8;
  }

  :global(body.dark-mode) .chevron {
    color: #94a3b8;
  }

  :global(body.dark-mode) .country-select {
    background: #1e293b;
    border-color: #334155;
    color: #e2e8f0;
  }

  :global(body.dark-mode) .country-select:disabled {
    background: #334155;
    color: #64748b;
  }

  @media (max-width: 768px) {
    .selector-controls {
      flex-direction: column;
      align-items: stretch;
    }

    .add-holidays-button {
      width: 100%;
    }
  }
</style>

<script>
  import { getDateStore } from '../lib/dateStore';

  const countrySelect = document.getElementById('country-select') as HTMLSelectElement;
  const addButton = document.getElementById('add-holidays-button') as HTMLButtonElement;
  const statusDiv = document.getElementById('holiday-status');
  const toggleButton = document.getElementById('selector-toggle') as HTMLButtonElement;
  const drawer = document.getElementById('selector-drawer');
  const dateStore = getDateStore();

  // Toggle drawer open/closed
  if (toggleButton && drawer) {
    toggleButton.addEventListener('click', () => {
      const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
      toggleButton.setAttribute('aria-expanded', String(!isExpanded));
      drawer.classList.toggle('open', !isExpanded);
    });
  }

  const BASE_URL = 'https://date.nager.at';

  async function loadCountries() {
    try {
      if (statusDiv) {
        statusDiv.className = 'holiday-status loading';
        statusDiv.textContent = 'Loading countries...';
      }

      // Dynamic import like NagerDateHolidayDataSource uses
      const { Configuration, CountryApi } = await import('nager_date_api_reference');

      const config = new Configuration({ basePath: BASE_URL });
      const countryApi = new CountryApi(config);

      const countries = await countryApi.apiV3AvailableCountriesGet();

      // Populate dropdown
      countrySelect.innerHTML = '<option value="">Select a country...</option>';
      countries
        .sort((a: { name: string }, b: { name: string }) => a.name.localeCompare(b.name))
        .forEach((country: { countryCode: string; name: string }) => {
          const option = document.createElement('option');
          option.value = country.countryCode;
          option.textContent = country.name;
          countrySelect.appendChild(option);
        });
      
      countrySelect.disabled = false;
      
      if (statusDiv) {
        statusDiv.textContent = '';
      }
    } catch (error) {
      console.error('Failed to load countries:', error);
      if (statusDiv) {
        statusDiv.className = 'holiday-status error';
        statusDiv.textContent = 'Failed to load countries. Please try again.';
      }
    }
  }

  function updateButtonState() {
    addButton.disabled = !countrySelect.value;
  }

  async function addHolidays() {
    const countryCode = countrySelect.value;
    if (!countryCode) return;

    try {
      if (statusDiv) {
        statusDiv.className = 'holiday-status loading';
        statusDiv.textContent = 'Fetching holidays...';
      }
      addButton.disabled = true;

      const currentYear = new Date().getFullYear();
      
      // Dynamic import
      const { Configuration, PublicHolidayApi } = await import('nager_date_api_reference');

      const config = new Configuration({ basePath: BASE_URL });
      const holidayApi = new PublicHolidayApi(config);

      const holidays = (await holidayApi.apiV3PublicHolidaysYearCountryCodeGet({ year: currentYear, countryCode })) as unknown as Array<{ date: string; name: string }>;

      const dateRange = dateStore.getDateRange();
      let addedCount = 0;

      for (const holiday of holidays) {
        const holidayDate = new Date(holiday.date);
        
        if (holidayDate >= dateRange.startDate && holidayDate <= dateRange.endDate) {
          const existingState = dateStore.getDateState(holidayDate);
          if (!existingState || existingState !== 'holiday') {
            dateStore.markDate(holidayDate, 'holiday', true);
            addedCount++;
          }
        }
      }

      if (statusDiv) {
        statusDiv.className = 'holiday-status success';
        statusDiv.textContent = `Added ${addedCount} holidays!`;
      }

      setTimeout(() => {
        if (statusDiv) {
          statusDiv.textContent = '';
        }
      }, 3000);
    } catch (error) {
      console.error('Failed to add holidays:', error);
      if (statusDiv) {
        statusDiv.className = 'holiday-status error';
        statusDiv.textContent = 'Failed to fetch holidays. Please try again.';
      }
    } finally {
      updateButtonState();
    }
  }

  loadCountries();
  countrySelect.addEventListener('change', updateButtonState);
  addButton.addEventListener('click', addHolidays);
</script>
