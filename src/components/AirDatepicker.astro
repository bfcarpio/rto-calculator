---
---

<div class="datepicker-container">
  <div id="air-datepicker" class="air-datepicker-inline"></div>
</div>

<style>
  .datepicker-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1rem;
    width: 100%;
    min-height: 300px;
  }

  :global(.air-datepicker) {
    width: 100% !important;
    max-width: 340px;
    font-family: inherit;
  }

  :global(.air-datepicker.-inline-) {
    position: static;
    width: 100% !important;
    max-width: 340px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  :global(.air-datepicker-inline) {
    width: 100% !important;
    max-width: 340px;
  }

  /* Ensure date cells have proper size */
  :global(.air-datepicker-cell) {
    height: 40px !important;
    width: 40px !important;
    font-size: 14px;
  }

  /* State color classes - applied to individual date cells */
  :global(.air-datepicker-cell.-working-) {
    background-color: #ffffff !important;
    color: #334155 !important;
  }

  :global(body.dark-mode .air-datepicker-cell.-working-) {
    background-color: #1e293b !important;
    color: #e2e8f0 !important;
  }

  :global(.air-datepicker-cell.-oof-) {
    background-color: var(--color-violation) !important;
    color: white !important;
  }

  :global(.air-datepicker-cell.-holiday-) {
    background-color: var(--color-holiday) !important;
    color: white !important;
  }

  /* Gray out dates outside range */
  :global(.air-datepicker-cell.-disabled-) {
    opacity: 0.3;
    cursor: not-allowed;
  }

  :global(.air-datepicker-body--day-cells) {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
  }

  :global(.air-datepicker-body--cells.-days-) {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
  }

  /* Selected date styling */
  :global(.air-datepicker-cell.-selected-) {
    font-weight: bold;
  }

  /* Dark mode support */
  :global(body.dark-mode .air-datepicker) {
    background: #1e293b;
    border-color: #334155;
  }

  :global(body.dark-mode .air-datepicker-nav) {
    background: #1e293b;
    border-color: #334155;
  }

  :global(body.dark-mode .air-datepicker-nav--title) {
    color: #e2e8f0;
  }

  :global(body.dark-mode .air-datepicker-body--cells) {
    background: #1e293b;
  }

  :global(body.dark-mode .air-datepicker-cell) {
    color: #cbd5e1;
  }

  :global(body.dark-mode .air-datepicker-cell.-other-month-) {
    color: #64748b;
  }

  :global(body.dark-mode .air-datepicker-cell.-disabled-) {
    color: #475569;
    opacity: 0.4;
  }

  @media (min-width: 768px) {
    :global(.air-datepicker) {
      max-width: 400px;
    }
    
    :global(.air-datepicker.-inline-) {
      max-width: 400px;
    }

    :global(.air-datepicker-cell) {
      height: 44px !important;
      width: 44px !important;
    }
  }
</style>

<script>
  import AirDatepicker from 'air-datepicker';
  import 'air-datepicker/air-datepicker.css';
  import localeEn from 'air-datepicker/locale/en';
  import {
    getDateStore,
    getDateState,
  } from '../lib/dateStore';
  import {
    getDateRange,
    isDateInRange,
  } from '../lib/dateUtils';

  const container = document.getElementById('air-datepicker');
  const store = getDateStore();
  let picker: InstanceType<typeof AirDatepicker> | null = null;

  if (container) {
    const dateRange = getDateRange();

    // Initialize Air Datepicker with English locale
    picker = new AirDatepicker(container, {
      inline: true,
      range: false,
      multipleDates: false,
      toggleSelected: false,
      locale: localeEn,
      
      // Custom cell renderer to show state colors and disable out-of-range dates
      onRenderCell({ date, cellType }) {
        if (cellType !== 'day') return;

        const isInRange = isDateInRange(date, dateRange);
        const dateState = getDateState(date);
        const year = date.getFullYear();
        const month = date.getMonth();
        const day = date.getDate();

        if (!isInRange) {
          return {
            disabled: true,
            classes: '-disabled-',
            attrs: {
              'data-testid': 'calendar-day',
              'data-year': String(year),
              'data-month': String(month),
              'data-day': String(day),
            }
          };
        }

        if (dateState) {
          return {
            classes: `-${dateState}-`,
            attrs: {
              'data-testid': 'calendar-day',
              'data-year': String(year),
              'data-month': String(month),
              'data-day': String(day),
            }
          };
        }

        return {
          attrs: {
            'data-testid': 'calendar-day',
            'data-year': String(year),
            'data-month': String(month),
            'data-day': String(day),
          }
        };
      },

      // Handle date selection
      onSelect({ date }) {
        if (!date) return;

        const selectedDate = date as Date;
        const isInRange = isDateInRange(selectedDate, dateRange);
        if (!isInRange) return;

        const currentMode = store.getMarkingMode();
        const existingState = getDateState(selectedDate);

        // Working mode acts as eraser - clears any existing marking
        if (currentMode === 'working') {
          if (existingState) {
            store.clearDate(selectedDate);
          }
          // If no existing state, do nothing (working is the default)
        } else {
          // Toggle: if clicking the same state, clear it; otherwise set to current mode
          if (existingState === currentMode) {
            store.clearDate(selectedDate);
          } else {
            store.markDate(selectedDate, currentMode);
          }
        }

        // Refresh the calendar to show updated colors
        picker?.update();
      },
    });

    // Subscribe to store changes to refresh the calendar
    store.subscribe(() => {
      picker?.update();
    });
  }
</script>
