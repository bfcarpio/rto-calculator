/**
 * RollingPeriodValidation Tests
 *
 * Tests for the RollingPeriodValidation class that validates RTO compliance
 * over rolling 12-week periods.
 *
 * @module RollingPeriodValidation.test
 */

import { beforeEach, describe, expect, it } from "vitest";

// Import the RollingPeriodValidation class
// Note: Using dynamic import to handle module loading
let RollingPeriodValidation: any;

describe("RollingPeriodValidation", () => {
	beforeEach(async () => {
		// Import the module dynamically for each test
		const module = await import("../validation/RollingPeriodValidation.js");
		RollingPeriodValidation = module.default || module;
	});

	describe("Class Instantiation", () => {
		it("should create instance with default configuration", () => {
			const validation = new RollingPeriodValidation();

			expect(validation.name).toBe("rolling-period");
			expect(validation.description).toBe(
				"Validates RTO compliance over rolling 12-week periods",
			);
			expect(validation.defaultConfig).toBeDefined();
			expect(validation.defaultConfig.minOfficeDaysPerWeek).toBe(3);
			expect(validation.defaultConfig.totalWeekdaysPerWeek).toBe(5);
			expect(validation.defaultConfig.rollingPeriodWeeks).toBe(12);
			expect(validation.defaultConfig.thresholdPercentage).toBe(0.6);
		});

		it("should have expected properties", () => {
			const validation = new RollingPeriodValidation();

			expect(validation.name).toBe("rolling-period");
			expect(validation.description).toBe(
				"Validates RTO compliance over rolling 12-week periods",
			);
			expect(validation.defaultConfig).toBeDefined();
		});

		// This test is no longer applicable as the implementation has changed
		// weekStart is no longer a property of the main class
		it.skip("should initialize with null weekStart", () => {
			// This property no longer exists in the simplified implementation
		});

it("should calculate correct average for window", () => {
		const validation = new RollingPeriodValidation();

		// Create selections for multiple weeks
		const selections = [];
		for (let week = 0; week < 12; week++) {
			for (let day = 0; day < 2; day++) {
				selections.push({
					year: 2025,
					month: 0,
					day: 6 + week * 7 + day,
					type: "out-of-office",
});
			}
		}

		const context = {
			selectedDays: selections,
			config: {
				minOfficeDaysPerWeek: 3,
				totalWeekdaysPerWeek: 5,
				rollingPeriodWeeks: 12,
				thresholdPercentage: 0.6,
				debug: false,
			},
		};

		const windowCompliance = validation.getWindowCompliance(0, 12, context, "average");

		// 2 WFH days per week = 3 office days per week = 60% = compliant
		expect(windowCompliance.isCompliant).toBe(true);
		expect(windowCompliance.averageOfficeDaysPerWeek).toBe(3);
		expect(windowCompliance.compliancePercentage).toBe(60);
	});
});

			const context = {
				selectedDays: [],
				config: {},
			};

});

	describe("reset()", () => {
		// This test is no longer applicable as the implementation has changed
		// The cache and weekStart are now internal to the strategy classes
		it.skip("should clear internal state", () => {
			// Cache and weekStart are now internal to the strategy classes and not exposed
		});
	});

	describe("isApplicable()", () => {
		it("should return true when selections exist", () => {
			const validation = new RollingPeriodValidation();

			const context = {
				selectedDays: [{ year: 2025, month: 0, day: 6 }],
			};

			expect(validation.isApplicable(context)).toBe(true);
		});

		it("should return false when selections is empty array", () => {
			const validation = new RollingPeriodValidation();

			const context = {
				selectedDays: [],
			};

			expect(validation.isApplicable(context)).toBe(false);
		});

		it("should return false when selectedDays is undefined", () => {
			const validation = new RollingPeriodValidation();

			const context = {
				selectedDays: undefined,
			} as any;

			expect(validation.isApplicable(context)).toBe(false);
		});
	});

	// These private helper methods are now internal to the strategy classes
	// and no longer accessible from the main RollingPeriodValidation class
	it.skip("Private Helper Methods", () => {
		// These methods are now internal to the strategy classes and not exposed
	});

	describe("Edge Cases and Error Handling", () => {
		it("should handle dates in different months", () => {
			const validation = new RollingPeriodValidation();

			const context = {
				selectedDays: [
					{ year: 2025, month: 0, day: 27 }, // Late January
					{ year: 2025, month: 1, day: 3 }, // Early February
				],
				config: {},
			};

			const result = validation.validate(context);

			expect(result).toBeDefined();
			expect(result.windowResults).toBeInstanceOf(Array);
		});

		it("should handle leap year dates", () => {
			const validation = new RollingPeriodValidation();

			// 2024 is a leap year
			const context = {
				selectedDays: [
					{ year: 2024, month: 1, day: 28 }, // Feb 28
					{ year: 2024, month: 1, day: 29 }, // Feb 29 (leap day)
				],
				config: {},
			};

			const result = validation.validate(context);

			expect(result).toBeDefined();
			expect(result.isValid).toBeDefined();
		});

		it("should handle year boundary crossings", () => {
			const validation = new RollingPeriodValidation();

			const context = {
				selectedDays: [
					{ year: 2024, month: 11, day: 30 }, // Dec 30
					{ year: 2025, month: 0, day: 2 }, // Jan 2
				],
				config: {},
			};

			const result = validation.validate(context);

			expect(result).toBeDefined();
			expect(result.isValid).toBeDefined();
		});
	});

	describe("Integration with Mock Holiday Data", () => {
		it("should exclude holidays from WFH counts when provided", () => {
			const validation = new RollingPeriodValidation();

			const context = {
				selectedDays: [
					{ year: 2025, month: 0, day: 6, type: "out-of-office" }, // Monday
					{ year: 2025, month: 0, day: 7, type: "out-of-office" }, // Tuesday
					{ year: 2025, month: 0, day: 8, type: "out-of-office" }, // Wednesday
				],
				config: {
					minOfficeDaysPerWeek: 3,
					totalWeekdaysPerWeek: 5,
					rollingPeriodWeeks: 12,
					thresholdPercentage: 0.6,
					debug: false,
				},
				holidayDates: [new Date(2025, 0, 6)], // Monday is a holiday
			};

			const result = validation.validate(context, "average");

			// Monday holiday should not count as WFH
			// So we effectively have 2 WFH days instead of 3
			// This should still be compliant (60%)
			expect(result.isValid).toBe(true);
		});
	});
});
