---
import Month from "../components/month.astro";

// Page metadata
const title = "RTO Calculator - Plan Your Time Off";
const description =
    "Plan your vacation for the next 365 days while ensuring compliance with RTO policies";

// Get current date to determine starting month
const now = new Date();
const startMonth = now.getMonth(); // 0-11
const startYear = now.getFullYear();

// Generate 12 months starting from current month
const months = Array.from({ length: 12 }, (_, index) => {
    const monthOffset = index;
    let month = (startMonth + monthOffset) % 12;
    let year = startYear + Math.floor((startMonth + monthOffset) / 12);

    return { month, year };
});
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content={description} />
        <title>{title}</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="stylesheet" href="/src/styles/global.css" />
        <link rel="stylesheet" href="/src/styles/pages/index.css" />
    </head>
    <body>
        <a href="#calendar" class="skip-link">Skip to calendar</a>

        <header class="calendar-header">
            <h1>RTO Calculator</h1>
            <p>
                Plan your time off while staying compliant with office
                attendance policies
            </p>

            <div
                id="compliance-indicator"
                class="compliance-indicator"
                role="status"
                aria-live="polite"
            >
                <span id="compliance-icon">‚úì</span>
                <span id="compliance-text">Loading...</span>
            </div>
        </header>

        <main id="calendar" class="calendar-container">
            <div
                id="validation-message"
                class="validation-message"
                role="status"
                aria-live="polite"
                style="display: none;"
            >
            </div>

            <div class="legend" role="region" aria-label="Calendar legend">
                <div class="legend-item">
                    <div class="legend-color compliant" aria-hidden="true">
                    </div>
                    <span>Compliant</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color violation" aria-hidden="true">
                    </div>
                    <span>Violation</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color work-from-home" aria-hidden="true">
                    </div>
                    <span>Work from Home</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color office" aria-hidden="true"></div>
                    <span>Office Day</span>
                </div>
            </div>

            <div
                class="months-grid"
                role="region"
                aria-label="12-month calendar"
            >
                {
                    months.map(({ month, year }) => (
                        <Month month={month} year={year} />
                    ))
                }
            </div>

            <div class="action-buttons">
                <button
                    id="validate-button"
                    class="button button-primary"
                    type="button"
                    aria-label="Validate RTO compliance"
                >
                    <span>‚úì</span> Validate
                </button>
                <button
                    id="clear-all-button"
                    class="button button-danger"
                    type="button"
                    aria-label="Clear all selections"
                >
                    <span>üóëÔ∏è</span> Clear All
                </button>
                <button
                    id="export-button"
                    class="button button-secondary"
                    type="button"
                    aria-label="Export selections"
                >
                    <span>üì•</span> Export
                </button>
            </div>
        </main>

        <footer>
            <p>
                <small>
                    RTO Calculator - Left-click for work from home, right-click
                    for office day
                </small>
            </p>
        </footer>

        <script>
            /**
             * Initialize clear all button functionality
             */
            function initClearAllButton() {
                const clearAllButton =
                    document.getElementById("clear-all-button");
                if (!clearAllButton) return;

                clearAllButton.addEventListener("click", (e) => {
                    e.preventDefault();

                    // Find all selected cells across all months
                    const selectedCells = document.querySelectorAll(
                        ".calendar-day.selected[data-year][data-month]",
                    );

                    if (selectedCells.length === 0) {
                        announceToScreenReader("No selections to clear");
                        return;
                    }

                    const clearedCount = selectedCells.length;

                    // Clear everything: selections, highlights, and status icons
                    if (
                        window.RTOValidation &&
                        window.RTOValidation.clearAllValidationHighlights
                    ) {
                        window.RTOValidation.clearAllValidationHighlights();
                    }

                    // Announce to screen readers
                    announceToScreenReader(
                        "Cleared " +
                            clearedCount +
                            " selection" +
                            (clearedCount !== 1 ? "s" : "") +
                            " from all months",
                    );

                    // Focus back on button
                    clearAllButton.focus();
                });

                // Add keyboard support
                clearAllButton.addEventListener("keydown", (e) => {
                    if (e.key === "Enter" || e.key === " ") {
                        e.preventDefault();
                        clearAllButton.click();
                    }
                });
            }

            function announceToScreenReader(message) {
                const announcement = document.createElement("div");
                announcement.setAttribute("role", "status");
                announcement.setAttribute("aria-live", "polite");
                announcement.setAttribute("aria-atomic", "true");
                announcement.className = "sr-only calendar-announcement";

                announcement.textContent = message;
                document.body.appendChild(announcement);

                // Remove announcement after it's been read
                setTimeout(() => {
                    document.body.removeChild(announcement);
                }, 1000);
            }
        </script>

        <!-- Load RTO validation script -->
        <script src="/src/scripts/rtoValidation.js"></script>

        <style>
            .calendar-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 1rem;
            }

            body {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 1rem;
            }

            .calendar-container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .months-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.75rem;
                padding: 1rem 0;
                justify-items: center;
            }

            /* Responsive layout for smaller screens */
            @media (max-width: 1024px) {
                .months-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 0.5rem;
                }
            }

            @media (max-width: 480px) {
                .months-grid {
                    grid-template-columns: 1fr;
                    gap: 0.25rem;
                }
            }

            /* Screen reader only content */
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border-width: 0;
            }

            /* Legend color styles */
            .legend-color.work-from-home {
                background-color: #1890ff;
            }

            .legend-color.office {
                background-color: #f5222d;
            }

            /* Validation message centered styling */
            .validation-message.centered-message {
                max-width: 800px;
                margin: 1rem auto;
                padding: 1rem;
                font-size: 1.1rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .validation-message.centered-message::before {
                content: "";
                width: 4px;
                height: 100%;
                position: absolute;
                left: 0;
                top: 0;
            }

            .validation-message.centered-message.success {
                border-left: 4px solid #52c41a;
                background-color: #f6ffed;
                color: #389e0d;
            }

            .validation-message.centered-message.error {
                border-left: 4px solid #ff4d4f;
                background-color: #fff2f0;
                color: #cf1322;
            }

            /* Evaluation and violation indicators are in status column only - no day highlighting */
        </style>
    </body>
</html>
