---
import Month from "../components/month.astro";
import ActionButtons from "../components/ActionButtons.astro";
import SettingsButton from "../components/SettingsButton.astro";
import SettingsModal from "../components/SettingsModal.astro";
import "../styles/global.css";
import "../styles/pages/index.css"

// Page metadata
const title = "RTO Calculator - Plan Your Time Off";
const description =
    "Plan your vacation for the next 365 days while ensuring compliance with RTO policies";

// Get current date to determine starting month
const now = new Date();
const startMonth = now.getMonth(); // 0-11
const startYear = now.getFullYear();

// Generate 12 months starting from current month
const months = Array.from({ length: 12 }, (_, index) => {
    const monthOffset = index;
    let month = (startMonth + monthOffset) % 12;
    let year = startYear + Math.floor((startMonth + monthOffset) / 12);

    return { month, year };
});
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content={description} />
        <title>{title}</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    </head>
    <body>
        <a href="#calendar" class="skip-link">Skip to calendar</a>

        <header class="calendar-header">
            <h1>RTO Calculator</h1>
            <p>
                Plan your time off while staying compliant with office
                attendance policies
            </p>

        </header>

        <main id="calendar-container" class="calendar-container">
            <div
                id="validation-message"
                class="validation-message prominent-message"
                role="status"
                aria-live="polite"
                style="display: none;"
            >
            </div>



            <ActionButtons position="top" />
            <SettingsButton />

            <div
                class="months-grid"
                role="region"
                aria-label="12-month calendar"
            >
                {
                    months.map(({ month, year }) => (
                        <Month month={month} year={year} />
                    ))
                }
            </div>
        </div>

        <ActionButtons position="bottom" />
    </main>

    <footer>
            <p>
                <small>
                    RTO Calculator - Left-click for work from home, right-click
                    for office day
                </small>
            </p>
    </footer>

    <SettingsModal />

    <script>
            // Import holiday data loader
            import { initHolidayDataLoader } from '../lib/holiday-data-loader';

            // Import localStorage integration
            import { initializeLocalStorage } from '../scripts/localStorage';

            // Import calendar event listeners (Clear All, Export buttons)
            import { setupEventListeners } from '../utils/astro/calendarFunctions';

            // Import calendar holiday integration
            import { initializeHolidayIntegration } from '../lib/calendar-holiday-integration';

            // Import new calendar events module (event delegation)
            import { initializeCalendarEvents } from '../scripts/calendar-events';

            // Extend Window interface for validation display function
            declare global {
                interface Window {
                    displayValidationResults?: (validationResult: any) => void;
                }
            }

            // Import validation display utility
            import { displayValidationResults, displayInitialPrompt } from '../scripts/validation-result-display';

            // Import RTO validation (attaches validate button event listeners)
            import '../scripts/rtoValidation';

            // Initialize holiday data loader (loads countries and holiday manager globally)
            // This must be called before SettingsModal initializes to populate the country dropdown
            initHolidayDataLoader();

            // Initialize localStorage integration (auto-save/load selections)
            initializeLocalStorage();

            // Setup event listeners for Clear All and Export buttons
            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupEventListeners);
            } else {
                setupEventListeners();
            }

            // Initialize calendar holiday integration
            initializeHolidayIntegration();

            // Initialize new calendar events module with event delegation
            // This replaces inline scripts in day.astro and month.astro
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeCalendarEvents);
            } else {
                initializeCalendarEvents();
            }

            // Make validation results accessible for testing
            window.displayValidationResults = function(validationResult: any) {
                displayValidationResults(validationResult);
            };

            // Display initial prompt to guide users
            displayInitialPrompt();

            console.log('[Index] Calendar initialized.');

            // Dispatch calendar-loaded event to notify holiday integration that calendar is ready
            // This triggers holiday application based on saved settings
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    const event = new CustomEvent('calendar-loaded', {
                        bubbles: true,
                        detail: {
                            timestamp: Date.now(),
                            monthsCount: 12
                        }
                    });
                    document.dispatchEvent(event);
                    console.log('[Index] Dispatched calendar-loaded event');
                });
            } else {
                const event = new CustomEvent('calendar-loaded', {
                    bubbles: true,
                    detail: {
                        timestamp: Date.now(),
                        monthsCount: 12
                    }
                });
                document.dispatchEvent(event);
                console.log('[Index] Dispatched calendar-loaded event');
            }

            console.log('[Index] Calendar initialized.');
   </script>

   <style>
            .calendar-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 1rem;
            }

            body {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 1rem;
            }

            .calendar-container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .months-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.75rem;
                padding: 1rem 0;
                justify-items: center;
            }

            /* Wide monitors - 4 columns */

            /* Responsive layout for smaller screens */
            @media (max-width: 1024px) {
                .months-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 0.5rem;
                }
            }

            @media (max-width: 480px) {
                .months-grid {
                    grid-template-columns: 1fr;
                    gap: 0.25rem;
                }
            }

            /* Screen reader only content */
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border-width: 0;
            }

    /* Legend color styles */
    .legend-color.out-of-office {
        background-color: #1890ff;
    }

            .legend-color.office {
                background-color: #f5222d;
            }

            /* Validation message centered styling */
            .validation-message.centered-message {
                max-width: 800px;
                margin: 1rem auto;
                padding: 1rem;
                font-size: 1.1rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .validation-message.centered-message::before {
                content: "";
                width: 4px;
                height: 100%;
                position: absolute;
                left: 0;
                top: 0;
            }

            .validation-message.centered-message.success {
                border-left: 4px solid #52c41a;
                background-color: #f6ffed;
                color: #389e0d;
            }

            .validation-message.centered-message.error {
                border-left: 4px solid #ff4d4f;
                background-color: #fff2f0;
                color: #cf1322;
            }

            /* Evaluation and violation indicators are in status column only - no day highlighting */
        </style>
    </body>
</html>
