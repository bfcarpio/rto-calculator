---
import Month from "../components/month.astro";
import ActionButtons from "../components/ActionButtons.astro";
import SettingsButton from "../components/SettingsButton.astro";
import SettingsModal from "../components/SettingsModal.astro";

// Page metadata
const title = "RTO Calculator - Plan Your Time Off";
const description =
    "Plan your vacation for the next 365 days while ensuring compliance with RTO policies";

// Get current date to determine starting month
const now = new Date();
const startMonth = now.getMonth(); // 0-11
const startYear = now.getFullYear();

// Generate 12 months starting from current month
const months = Array.from({ length: 12 }, (_, index) => {
    const monthOffset = index;
    let month = (startMonth + monthOffset) % 12;
    let year = startYear + Math.floor((startMonth + monthOffset) / 12);

    return { month, year };
});
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="description" content={description} />
        <title>{title}</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="stylesheet" href="/src/styles/global.css" />
        <link rel="stylesheet" href="/src/styles/pages/index.css" />
    </head>
    <body>
        <a href="#calendar" class="skip-link">Skip to calendar</a>

        <header class="calendar-header">
            <h1>RTO Calculator</h1>
            <p>
                Plan your time off while staying compliant with office
                attendance policies
            </p>

            <div
                id="compliance-indicator"
                class="compliance-indicator"
                role="status"
                aria-live="polite"
            >
                <span id="compliance-icon">âœ“</span>
                <span id="compliance-text">Loading...</span>
            </div>
        </header>

        <main id="calendar" class="calendar-container">
            <div
                id="validation-message"
                class="validation-message prominent-message"
                role="status"
                aria-live="polite"
                style="display: none;"
            >
            </div>



            <ActionButtons position="top" />
            <SettingsButton />

            <div
                class="months-grid"
                role="region"
                aria-label="12-month calendar"
            >
                {
                    months.map(({ month, year }) => (
                        <Month month={month} year={year} />
                    ))
                }
            <SettingsModal />
        </div>

        <ActionButtons position="bottom" />
    </main>

    <SettingsModal />

    <footer>
            <p>
                <small>
                    RTO Calculator - Left-click for work from home, right-click
                    for office day
                </small>
            </p>
        </footer>

        <script>
            /**
             * Initialize validate button functionality
             */
            function initValidateButtons() {
                const validateButtons = document.querySelectorAll(
                    '[id^="validate-button-"]',
                );
                validateButtons.forEach((button) => {
                    button.addEventListener("click", (e) => {
                        e.preventDefault();
                        if (
                            window.RTOValidation &&
                            window.RTOValidation.runValidationWithHighlights
                        ) {
                            window.RTOValidation.runValidationWithHighlights();
                        }
                        (button as HTMLElement).focus();
                    });
                });
            }

            /**
             * Initialize clear all button functionality
             */
            function initClearAllButtons() {
                const clearAllButtons = document.querySelectorAll(
                    '[id^="clear-all-button-"]',
                );
                clearAllButtons.forEach((button) => {
                    button.addEventListener("click", (e) => {
                        e.preventDefault();

                        // Find all selected cells across all months
                        const selectedCells = document.querySelectorAll(
                            ".calendar-day.selected[data-year][data-month]",
                        );

                        if (selectedCells.length === 0) {
                            announceToScreenReader("No selections to clear");
                            return;
                        }

                        const clearedCount = selectedCells.length;

                        // Clear everything: selections, highlights, and status icons
                        if (
                            window.RTOValidation &&
                            window.RTOValidation.clearAllValidationHighlights
                        ) {
                            window.RTOValidation.clearAllValidationHighlights();
                        }

                        // Announce to screen readers
                        announceToScreenReader(
                            "Cleared " +
                                clearedCount +
                                " selection" +
                                (clearedCount !== 1 ? "s" : "") +
                                " from all months",
                        );

                        // Focus back on button
                        (button as HTMLElement).focus();
                    });

                    // Add keyboard support
                    button.addEventListener("keydown", (e) => {
                        const keyboardEvent = e as KeyboardEvent;
                        if (
                            keyboardEvent.key === "Enter" ||
                            keyboardEvent.key === " "
                        ) {
                            e.preventDefault();
                            (button as HTMLElement).click();
                        }
                    });
                });
            }

            /**
             * Initialize export button functionality
             */
            function initExportButtons() {
                const exportButtons = document.querySelectorAll(
                    '[id^="export-button-"]',
                );
                exportButtons.forEach((button) => {
                    button.addEventListener("click", (e) => {
                        e.preventDefault();
                        // TODO: Implement export functionality
                        announceToScreenReader(
                            "Export functionality coming soon",
                        );
                        (button as HTMLElement).focus();
                    });

                    // Add keyboard support
                    button.addEventListener("keydown", (e) => {
                        const keyboardEvent = e as KeyboardEvent;
                        if (
                            keyboardEvent.key === "Enter" ||
                            keyboardEvent.key === " "
                        ) {
                            e.preventDefault();
                            (button as HTMLElement).click();
                        }
                    });
                });
            }

            /**
             * Announce a message to screen readers
             * @param {string} message - The message to announce
             */
            function announceToScreenReader(message: string) {
                const announcement = document.createElement("div");
                announcement.setAttribute("role", "status");
                announcement.setAttribute("aria-live", "polite");
                announcement.setAttribute("aria-atomic", "true");
                announcement.className = "sr-only calendar-announcement";

                announcement.textContent = message;
                document.body.appendChild(announcement);

                // Remove announcement after it's been read
                setTimeout(() => {
                    document.body.removeChild(announcement);
                }, 1000);
            }

            // Initialize all buttons when DOM is ready
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", () => {
                    initValidateButtons();
                    initClearAllButtons();
                    initExportButtons();
                });
            } else {
                initValidateButtons();
                initClearAllButtons();
                initExportButtons();
            }
        </script>

    <!-- Load validation scripts in correct order -->
    <script src="/src/scripts/rtoValidation.ts"></script>

        <style>
            .calendar-container {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 1rem;
            }

            body {
                max-width: 1400px;
                margin: 0 auto;
                padding: 0 1rem;
            }

            .calendar-container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .months-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr);
                gap: 0.75rem;
                padding: 1rem 0;
                justify-items: center;
            }

            /* Wide monitors - 4 columns */

            /* Responsive layout for smaller screens */
            @media (max-width: 1024px) {
                .months-grid {
                    grid-template-columns: repeat(2, 1fr);
                    gap: 0.5rem;
                }
            }

            @media (max-width: 480px) {
                .months-grid {
                    grid-template-columns: 1fr;
                    gap: 0.25rem;
                }
            }

            /* Screen reader only content */
            .sr-only {
                position: absolute;
                width: 1px;
                height: 1px;
                padding: 0;
                margin: -1px;
                overflow: hidden;
                clip: rect(0, 0, 0, 0);
                white-space: nowrap;
                border-width: 0;
            }

            /* Legend color styles */
            .legend-color.work-from-home {
                background-color: #1890ff;
            }

            .legend-color.office {
                background-color: #f5222d;
            }

            /* Validation message centered styling */
            .validation-message.centered-message {
                max-width: 800px;
                margin: 1rem auto;
                padding: 1rem;
                font-size: 1.1rem;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                display: flex;
                align-items: center;
                gap: 0.75rem;
            }

            .validation-message.centered-message::before {
                content: "";
                width: 4px;
                height: 100%;
                position: absolute;
                left: 0;
                top: 0;
            }

            .validation-message.centered-message.success {
                border-left: 4px solid #52c41a;
                background-color: #f6ffed;
                color: #389e0d;
            }

            .validation-message.centered-message.error {
                border-left: 4px solid #ff4d4f;
                background-color: #fff2f0;
                color: #cf1322;
            }

            /* Evaluation and violation indicators are in status column only - no day highlighting */
        </style>
    </body>
</html>
